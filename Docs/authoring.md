# Creating Custom Monitoring Packs (IaaS)

To create your own monitoring packs, you need to define them within the [`PacksDef.json`](c:\git\AzureMonitorStarterPacks\Packs\PacksDef.json) file. This file contains a root object with a single key, `Packs`, which holds an array of objects. Each object in this array represents a single monitoring pack definition.

## Pack Definition Structure

Each pack object within the `Packs` array should follow this structure:

1.  **Pack Metadata:** Basic information about the pack.
    *   `Name`: (String, Required) The user-friendly display name for the pack (e.g., "My Custom Web App").
    *   `Tag`: (String, Required) A short, unique identifier used internally to associate resources with this pack (e.g., "MyWebApp"). **Must be unique across all packs.**
    *   `Description`: (String, Required) A brief explanation of what the pack monitors.
    *   `OS`: (String, Required) The target operating system for the pack. Valid values are `"Windows"`, `"Linux"`, or `"All"`.

2.  **Rules (`Rules` array):** Defines how data should be collected for this pack. This is an array of rule objects.
    *   Each rule object defines a specific Data Collection Rule (DCR) to be created.
    *   `Rulename`: (String, Required) A descriptive name for this specific data collection rule within the pack (e.g., "WebAppLogs", "WebAppPerf").
    *   `RuleType`: (String, Required) Specifies the kind of data collection. Common types include:
        *   `EventPerformance`: Collects Windows Events via XPath queries and/or Windows Performance Counters. Requires `xPathQueries` and/or `performanceCounters`. Typically uses `dcr-basicWinVM.bicep` or `dcr-basicLinuxVM.bicep`.
        *   `VMInsights`: Enables the standard Azure Monitor VM Insights data collection. Typically uses `DefaultVMI-rule.bicep`.
        *   `IISLogs`: Collects IIS log files. Often combined with `EventPerformance` properties (`xPathQueries`, `performanceCounters`) in the same rule definition if needed. Requires `fileCollection`. Typically uses `filecollectionWinIIS.bicep`.
        *   `syslog`: Collects Linux syslog messages, potentially filtering by facility and severity level. Can also collect from specific log files. Requires `filepatterns`. May use `facilitynames`, `logLevels`, `kqlTransformation`, `tableName`. Typically uses `filecollectionSyslogLinux.bicep`.
        *   `CustomData`: Collects data from custom log files, often generated by a VM Application deployed alongside the DCR. Requires `filepatterns`, `tableName`, and VM Application details (`clientAppName`, `clientAppZIPURL`, etc.). Typically uses `customDataDCR.bicep`.
        *   `ServiceMap`: Configures the Dependency Agent for Service Map visualization. Typically uses `ServiceMap.bicep`.
    *   `RuleNamePath`: (String, Required) The relative path (from the `Packs/IaaS` directory) to the Bicep template file used to deploy the DCR for this rule (e.g., `dcr-basicWinVM.bicep`).
    *   **RuleType-Specific Properties:** Additional properties are required based on the `RuleType`:
        *   For `EventPerformance`:
            *   `xPathQueries`: (Array of Strings) XPath queries to filter Windows Event Logs (e.g., `"System!*[System[Provider[@Name=\\'MyProvider\\'] and (EventID=1234)]]"`). Note the escaped backslashes and single quotes.
            *   `performanceCounters`: (Array of Strings) Paths for Windows Performance Counters (e.g., `"\\Processor(_Total)\\% Processor Time"`).
        *   For `IISLogs`:
            *   `fileCollection`: (Array of Objects) Defines settings for collecting files. Each object needs:
                *   `filePath`: (String) Path to the log files (e.g., `"C:\\inetpub\\logs\\LogFiles\\W3SVC*"`).
                *   `fileNamePattern`: (String) Pattern to match log files (e.g., `"*.log"`).
                *   `fileType`: (String) Type identifier (e.g., `"IISLogs"`).
                *   `fileTypeName`: (String) Display name for the file type (e.g., `"IISLogs"`).
            *   Can also include `xPathQueries` and `performanceCounters` if needed.
        *   For `syslog`:
            *   `syslogDataSourceName`: (String) A unique name for the syslog data source within the DCR.
            *   `filepatterns`: (Array of Strings) Paths/patterns for log files to monitor (e.g., `"/var/log/my_app/*.log"`).
            *   `facilitynames`: (Array of Strings, Optional) Syslog facilities to filter (e.g., `["daemon", "local0"]`).
            *   `logLevels`: (Array of Strings, Optional) Syslog severity levels to filter (e.g., `["Error", "Critical"]`).
            *   `kqlTransformation`: (String, Optional) A KQL query to transform the data before ingestion. Use `source` to refer to the incoming data.
            *   `tableName`: (String, Required if `kqlTransformation` is used or for custom files) The name of the target custom log table in Log Analytics (must end in `_CL`).
            *   `createTable`: (Boolean, Optional) Set to `true` if the `tableName` needs to be created.
        *   For `CustomData`:
            *   `filepatterns`: (Array of Strings) Path/pattern for the custom log files (e.g., `"C:\\MyApp\\Logs\\*.log"`).
            *   `tableName`: (String, Required) The target custom log table name (must end in `_CL`).
            *   `clientAppName`: (String, Required) Name for the VM Application resource.
            *   `clientAppDescription`: (String, Required) Description for the VM Application.
            *   `clientAppVersion`: (String, Required) Version for the VM Application (e.g., "1.0.0").
            *   `clientAppInstallCommand`: (String, Required) The command to install the VM Application package on the VM.
            *   `clientAppUninstallCommand`: (String, Required) The command to uninstall the VM Application.
            *   `clientAppZIPURL`: (String, Required) URL to the zip package for the VM Application.

3.  **Alerts (`Alerts` array):** Defines Azure Monitor alert rules based on the data collected by the `Rules`. This is an array of alert objects.
    *   Each alert object defines a specific Log Alert rule to be created.
    *   `alertRuleDescription`: (String, Required) A detailed description of the alert's purpose.
    *   `alertRuleDisplayName`: (String, Required) The user-friendly name displayed in Azure Monitor Alerts.
    *   `alertRuleName`: (String, Required) A unique programmatic name for the alert rule resource (e.g., "AlertRule-MyApp-HighCpu"). **Must be unique across all alerts.**
    *   `alertRuleSeverity`: (Integer, Required) Severity level (0=Sev0, 1=Sev1, 2=Sev2, 3=Sev3, 4=Sev4).
    *   `autoMitigate`: (Boolean, Required) Set to `true` if the alert should automatically resolve when the condition is no longer met.
    *   `evaluationFrequency`: (String, Required) How often the alert query is run (ISO 8601 duration format, e.g., `"PT5M"` for 5 minutes).
    *   `windowSize`: (String, Required) The time window of data the alert query evaluates (ISO 8601 duration format, e.g., `"PT15M"` for 15 minutes).
    *   `alertType`: (String, Required) The type of alert logic:
        *   `rows`: Triggers if the `query` returns one or more rows.
        *   `Aggregated`: Triggers based on an aggregated numeric value from the `query`. Requires `metricMeasureColumn`, `operator`, and `threshold`.
    *   `query`: (String, Required) The KQL query used to detect the alert condition. This query runs against the Log Analytics workspace.
    *   **AlertType-Specific Properties:**
        *   For `Aggregated`:
            *   `metricMeasureColumn`: (String, Required) The column in the `query` result containing the numeric value to evaluate (e.g., `"AggregatedValue"`).
            *   `operator`: (String, Required) The comparison operator (e.g., `"GreaterThan"`, `"LessThan"`, `"Equals"`).
            *   `threshold`: (Integer or Float, Required) The numeric threshold for the comparison.

## Example Custom Pack

Add a new object similar to this example to the `Packs` array in `PacksDef.json`:

````json
// filepath: c:\git\AzureMonitorStarterPacks\Packs\PacksDef.json
{
    "Packs": [
        // ... existing pack definitions ...
        {
            "Name": "My Custom Linux App",
            "Tag": "MyLinuxApp",
            "Description": "Monitors custom logs and basic CPU for My Linux App.",
            "OS": "Linux",
            "Rules": [
                {
                    "Rulename": "MyLinuxAppLogs",
                    "RuleType": "syslog",
                    "RuleNamePath": "filecollectionSyslogLinux.bicep", // Reuse existing template
                    "syslogDataSourceName": "sysLogsDataSource-MyLinuxApp",
                    "filepatterns": [
                        "/var/log/my_linux_app/app.log" // Path to your app's log file
                    ],
                    "facilitynames": [ "local1" ], // Assuming app logs to local1 facility
                    "logLevels": [ "Error", "Critical", "Alert", "Emergency" ],
                    "tableName": "MyLinuxAppLogs_CL", // Target custom table
                    "createTable": true
                },
                {
                    "Rulename": "MyLinuxAppCPU",
                    "RuleType": "EventPerformance", // Use for Linux perf counters too
                    "RuleNamePath": "dcr-basicLinuxVM.bicep", // Reuse existing template
                    "performanceCounters": [
                         // Standard Linux CPU counter via VM Insights metrics (if VMI pack is also used)
                         // Or specific counters if using OMI agent directly (less common now)
                         // Example using InsightsMetrics (requires VMI pack):
                         // This rule might be redundant if VMI pack is always used,
                         // but shown here for structure. Alerts can query InsightsMetrics directly.
                    ],
                    "xPathQueries": [] // Not applicable for Linux
                }
            ],
            "Alerts": [
                {
                    "alertRuleDescription": "A critical error was detected in My Linux App logs.",
                    "alertRuleDisplayName": "My Linux App - Critical Error",
                    "alertRuleName": "AlertRule-MyLinuxApp-CriticalError",
                    "alertRuleSeverity": 1,
                    "autoMitigate": false,
                    "evaluationFrequency": "PT5M",
                    "windowSize": "PT10M",
                    "alertType": "rows",
                    "query": "MyLinuxAppLogs_CL | where SyslogMessage contains 'CRITICAL_FAILURE'" // Query your custom table
                },
                {
                    "alertRuleDescription": "High CPU utilization detected on server running My Linux App.",
                    "alertRuleDisplayName": "My Linux App Server - High CPU",
                    "alertRuleName": "AlertRule-MyLinuxApp-HighCPU",
                    "alertRuleSeverity": 2,
                    "autoMitigate": true,
                    "evaluationFrequency": "PT5M",
                    "windowSize": "PT15M",
                    "alertType": "Aggregated",
                    // Assumes VM Insights (VMI pack) is also applied to the VM
                    "query": "InsightsMetrics\n| where Origin == 'vm.azm.ms'\n| where Namespace == 'Processor' and Name == 'UtilizationPercentage'\n| summarize AggregatedValue = avg(Val) by bin(TimeGenerated, 15m), Computer, _ResourceId",
                    "metricMeasureColumn": "AggregatedValue",
                    "operator": "GreaterThan",
                    "threshold": 90
                }
            ]
        }
        // ... more pack definitions ...
    ]
}
