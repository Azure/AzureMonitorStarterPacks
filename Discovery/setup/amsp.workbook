{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# Azure Monitor Starter Packs - Admin Centre\n\nDiscovery Configuration - Machines on the left have the Monitoring tag set, with at least one Starter Pack.\n\nAlert Management - Enable Disable Alerts\n\nConfig - configuration details"
      },
      "customWidth": "50",
      "name": "text - 5"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "value::all"
        ],
        "parameters": [
          {
            "id": "7a778b2c-619d-4f82-bd1c-810f853af6fd",
            "version": "KqlParameterItem/1.0",
            "name": "Subscriptions",
            "type": 6,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "includeAll": false,
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "value": [
              "value::all"
            ]
          },
          {
            "id": "1efb8bbe-532a-491b-b3c4-55f1402ee280",
            "version": "KqlParameterItem/1.0",
            "name": "logicAppResource",
            "label": "Logic App",
            "type": 5,
            "isRequired": true,
            "query": "resources\n| where type == \"microsoft.logic/workflows\"\n| project Id=id, Name=name",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.logic/workflows": true
              },
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": "/subscriptions/6c64f9ed-88d2-4598-8de6-7a9527dc16ca/resourceGroups/AMonStarterPacks3/providers/Microsoft.Logic/workflows/Discovery"
          },
          {
            "id": "4552c35d-c26c-4cbf-a4cf-b2e57ff7ee78",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "label": "WorkSpace",
            "type": 5,
            "isRequired": true,
            "isGlobal": true,
            "query": "resources\n| where type == \"microsoft.operationalinsights/workspaces\"\n| project id",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": "/subscriptions/6c64f9ed-88d2-4598-8de6-7a9527dc16ca/resourceGroups/Amonstarterpacks3/providers/Microsoft.OperationalInsights/workspaces/amonstar3"
          }
        ],
        "style": "above",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "customWidth": "50",
      "name": "parameters - 6"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "15f0fa97-4286-48d6-9dea-26a956197d26",
            "cellValue": "tabSelection",
            "linkTarget": "parameter",
            "linkLabel": "Discovery/Setup",
            "subTarget": "discovery",
            "style": "link"
          },
          {
            "id": "7499a88f-a536-41d7-9b58-9ebae1b5290e",
            "cellValue": "tabSelection",
            "linkTarget": "parameter",
            "linkLabel": "Alert Management",
            "subTarget": "alertmanagement",
            "style": "link"
          },
          {
            "id": "3a19e3a9-d64d-41d8-a313-3a60db36bcc4",
            "cellValue": "tabSelection",
            "linkTarget": "parameter",
            "linkLabel": "Policy Status",
            "subTarget": "policystatus",
            "style": "link"
          },
          {
            "id": "c2a67d72-dd46-44ea-adba-b9d70915c607",
            "cellValue": "tabSelection",
            "linkTarget": "parameter",
            "linkLabel": "Rule Management",
            "subTarget": "rulemanagement",
            "style": "link"
          },
          {
            "id": "d8f7936d-170f-430d-af7d-ac22115a9e38",
            "cellValue": "tabSelection",
            "linkTarget": "parameter",
            "linkLabel": "Config",
            "subTarget": "config",
            "style": "link"
          }
        ]
      },
      "name": "links - 8"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources | where type =~ 'microsoft.compute/virtualmachines' or type =~ 'microsoft.hybridcompute/machines' \n| where isnotempty(tolower(tags.MonitorStarterPacks))\n| project Server=id,['Resource Group']=resourceGroup, Packs=tags.MonitorStarterPacks",
              "size": 0,
              "title": "Monitored Machines",
              "exportMultipleValues": true,
              "exportedParameters": [
                {
                  "fieldName": "",
                  "parameterName": "taggedVMs",
                  "parameterType": 5,
                  "quote": ""
                }
              ],
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscriptions}"
              ],
              "visualization": "table",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "$gen_link_Packs_2",
                    "sortOrder": 1
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "$gen_link_Packs_2",
                  "sortOrder": 1
                }
              ]
            },
            "name": "Monitored Machines",
            "styleSettings": {
              "margin": "400",
              "padding": "400",
              "showBorder": true
            }
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "parameters": [
                {
                  "id": "54f2c7fb-7251-43b6-aa4d-fd94647cac4a",
                  "version": "KqlParameterItem/1.0",
                  "name": "PackTagDisable",
                  "label": "Select Pack To Disable or to Add",
                  "type": 2,
                  "isGlobal": true,
                  "query": "resources\n| where type == \"microsoft.insights/scheduledqueryrules\"\n| where isnotempty(tags.MonitorStarterPacks)\n| project MPs=tostring(tags.MonitorStarterPacks)\n| summarize by MPs\n",
                  "crossComponentResources": [
                    "{Workspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "value": "WOS"
                }
              ],
              "style": "pills",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "customWidth": "50",
            "name": "parameters - 5 - Copy"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "bullets",
              "links": [
                {
                  "id": "36b65f94-1c3d-4e7a-b771-677a2081d288",
                  "cellValue": "",
                  "linkTarget": "ArmAction",
                  "linkLabel": "Remove Monitoring for {PackTagDisable} Pack ",
                  "preText": "",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{logicAppResource}/triggers/manual/run?api-version=2016-06-01",
                    "headers": [],
                    "params": [
                      {
                        "key": "action",
                        "value": "removeTag"
                      }
                    ],
                    "body": "{ \"Action\":\"RemoveTag\", \n\"Servers\":  [{taggedVMs}],\n\"Pack\": \"{PackTagDisable}\"\n}",
                    "httpMethod": "POST",
                    "description": "# Actions can potentially modify resources.\n## Please use caution and include a confirmation message in this description when authoring this command."
                  }
                },
                {
                  "id": "550df977-06a8-4c40-9cd3-aba6286ebcdf",
                  "linkTarget": "ArmAction",
                  "linkLabel": "Add Monitoring for {PackTagDisable} Pack",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{logicAppResource}/triggers/manual/run?api-version=2016-06-01",
                    "headers": [],
                    "params": [],
                    "body": "{ \"Action\":\"AddTag\", \n\"Servers\":  [{taggedVMs}],\n\"Pack\": \"{PackTagDisable}\"\n}",
                    "httpMethod": "POST",
                    "description": "# Actions can potentially modify resources.\n## Please use caution and include a confirmation message in this description when authoring this command."
                  }
                },
                {
                  "id": "3b1af630-47ab-43e9-a5b2-d2f2e21880d0",
                  "linkTarget": "ArmAction",
                  "linkLabel": "Remove All Monitoring for VM",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{logicAppResource}/triggers/manual/run?api-version=2016-06-01",
                    "headers": [],
                    "params": [],
                    "body": "{ \"Action\":\"RemoveTag\", \n\"Servers\":  [{taggedVMs}],\n\"Pack\": \"All\"\n}",
                    "httpMethod": "POST",
                    "description": "# Actions can potentially modify resources.\n## Please use caution and include a confirmation message in this description when authoring this command."
                  }
                }
              ]
            },
            "customWidth": "50",
            "name": "links - 1"
          }
        ],
        "exportParameters": true
      },
      "conditionalVisibility": {
        "parameterName": "tabSelection",
        "comparison": "isEqualTo",
        "value": "discovery"
      },
      "customWidth": "50",
      "name": "TaggedGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources | where type =~ 'microsoft.compute/virtualmachines' or type =~ 'microsoft.hybridcompute/machines' \n| where isempty(tolower(tags.MonitorStarterPacks)) //and subscriptionId in split('{Subscriptions:subscriptionId}',',')\n| project Server=id,['Resource Group']=resourceGroup",
              "size": 0,
              "title": "Non-monitored Machines",
              "exportMultipleValues": true,
              "exportedParameters": [
                {
                  "parameterName": "vmstotag",
                  "parameterType": 1,
                  "quote": ""
                }
              ],
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscriptions}"
              ],
              "visualization": "table"
            },
            "name": "Non Discoverable Machines",
            "styleSettings": {
              "margin": "400",
              "padding": "400",
              "showBorder": true
            }
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "8a177eab-edac-41cc-84f9-a5b7de931bea",
                  "version": "KqlParameterItem/1.0",
                  "name": "PackTags",
                  "label": "Select Pack to Enable",
                  "type": 2,
                  "isGlobal": true,
                  "query": "resources\n| where type == \"microsoft.insights/scheduledqueryrules\"\n| where isnotempty(tags.MonitorStarterPacks)\n| project MPs=tostring(tags.MonitorStarterPacks)\n| summarize by MPs\n",
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "value": "IIS"
                }
              ],
              "style": "pills",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "customWidth": "50",
            "name": "parameters - 5"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "bullets",
              "links": [
                {
                  "id": "91fb0fed-0e4f-41ce-9024-98a3cc4432a7",
                  "linkTarget": "ArmAction",
                  "linkLabel": "Enable Monitoring for {PackTags} Pack",
                  "preText": "",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{logicAppResource}/triggers/manual/run?api-version=2016-06-01",
                    "headers": [],
                    "params": [
                      {
                        "key": "action",
                        "value": "addTag"
                      }
                    ],
                    "body": "{ \n  \"Function\": \"tagmgmt\",\n  \"Action\":\"AddTag\",\n  \"Servers\": [{vmstotag}],\n  \"Pack\": \"{PackTags}\"\n}",
                    "httpMethod": "POST",
                    "description": "# Actions can potentially modify resources.\n## Please use caution and include a confirmation message in this description when authoring this command."
                  }
                }
              ]
            },
            "customWidth": "50",
            "name": "links - 1 - Copy"
          }
        ],
        "exportParameters": true
      },
      "conditionalVisibility": {
        "parameterName": "tabSelection",
        "comparison": "isEqualTo",
        "value": "discovery"
      },
      "customWidth": "50",
      "name": "NonTaggedGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Alert Management",
        "items": [
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{Subscriptions}"
              ],
              "parameters": [
                {
                  "id": "e99b4870-f7a6-4b8e-95b7-6aaeece1f438",
                  "version": "KqlParameterItem/1.0",
                  "name": "AlertPack",
                  "type": 2,
                  "query": "resources\n| where type == \"microsoft.insights/scheduledqueryrules\"\n| where isnotempty(tags.MonitorStarterPacks)\n| project MPs=tostring(tags.MonitorStarterPacks)\n| summarize by MPs\n",
                  "crossComponentResources": [
                    "{Subscriptions}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": []
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "value": "WOS"
                }
              ],
              "style": "pills",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "name": "parameters - 7"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\n| where type == \"microsoft.insights/scheduledqueryrules\"\n| where isnotempty(tags.MonitorStarterPacks)\n| project name,MP=tags.MonitorStarterPacks, Enabled=properties.enabled, Description=properties.description\n| where MP=='{AlertPack}'",
              "size": 0,
              "exportMultipleValues": true,
              "exportedParameters": [
                {
                  "fieldName": "",
                  "parameterName": "alertsselected",
                  "parameterType": 1,
                  "quote": ""
                }
              ],
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscriptions}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "name",
                    "formatter": 7
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 6"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "bullets",
              "links": [
                {
                  "id": "f5cb3ede-91d1-4414-bfa1-a1689f45d0c8",
                  "linkTarget": "ArmAction",
                  "linkLabel": "Enable Alerts",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{logicAppResource}/triggers/manual/run?api-version=2016-06-01",
                    "headers": [],
                    "params": [],
                    "body": "{ \"Action\":\"Enable\", \n\"alerts\":  [{alertsselected}]\n}",
                    "httpMethod": "POST",
                    "description": "# Actions can potentially modify resources.\n## Please use caution and include a confirmation message in this description when authoring this command."
                  }
                },
                {
                  "id": "d9469141-a104-4696-b9cd-f0fc7e3f963e",
                  "linkTarget": "ArmAction",
                  "linkLabel": "Disable Alerts",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "headers": [],
                    "params": [],
                    "body": "{ \"Action\":\"Disable\", \n\"alerts\":  [{alertsselected}]\n}",
                    "httpMethod": "POST",
                    "description": "# Actions can potentially modify resources.\n## Please use caution and include a confirmation message in this description when authoring this command."
                  }
                }
              ]
            },
            "customWidth": "50",
            "name": "links - 8"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tabSelection",
        "comparison": "isEqualTo",
        "value": "alertmanagement"
      },
      "name": "AlertMGMT"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{Subscriptions}"
              ],
              "parameters": [
                {
                  "id": "ef1561b3-5e9d-4134-bb2a-7da8e77ddedc",
                  "version": "KqlParameterItem/1.0",
                  "name": "CollectionRule",
                  "label": "Collection Rule",
                  "type": 2,
                  "query": "resources\n| where type == \"microsoft.insights/datacollectionrules\"\n| extend MPs=tostring(['tags'].MonitorStarterPacks)\n| where isnotempty(MPs) or properties.dataSources.performanceCounters[0].name == 'VMInsightsPerfCounters'\n| summarize by name\n",
                  "crossComponentResources": [
                    "{Subscriptions}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": []
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "value": "AzMonPacks-IISBasicIISMonitoring"
                }
              ],
              "style": "pills",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "name": "parameters - 7"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "insightsresources\n| where type == \"microsoft.insights/datacollectionruleassociations\"\n| extend resourceId=split(id,'/providers/Microsoft.Insights/')[0]\n| where isnotnull(properties.dataCollectionRuleId)\n| project resourceName=split(resourceId,\"/\")[8],resourceId, rulename=split(properties.dataCollectionRuleId,\"/\")[8]//ruleId=properties.dataCollectionRuleId\n| where rulename=='{CollectionRule}'",
              "size": 0,
              "title": "Rule Association",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Group",
                    "formatter": 1
                  }
                ]
              }
            },
            "name": "query - 6"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tabSelection",
        "comparison": "isEqualTo",
        "value": "rulemanagement"
      },
      "name": "rulemanagement"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "externaldata(PackName: string, RequiredTag:string, Status:string)\n[ \n   h@'https://amonstarterpacks2abbd.blob.core.windows.net/discovery/packs.json'\n]\nwith(format='multijson', ingestionMapping='[{\"PackName\":\"PackName\",\"RequiredTag\":\"RequiredTag\", \"Status\":\"Status\"}]')\n| where Status == 'Enabled'\n",
        "size": 1,
        "title": "Available Packs (Enabled) from Json file in SA",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{Workspace}"
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tabSelection",
        "comparison": "isEqualTo",
        "value": "Config"
      },
      "name": "availPacks"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "policyresources | where type == \"microsoft.policyinsights/policystates\" | extend policyName=tostring(properties.policyDefinitionName), complianceState=properties.complianceState\n| join (policyresources | where type == \"microsoft.authorization/policydefinitions\" and isnotempty(properties.metadata.MonitorStarterPacks) | project policyName=name) on policyName\n| project policyName, complianceState",
        "size": 0,
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{Subscriptions}"
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tabSelection",
        "comparison": "isEqualTo",
        "value": "policystatus"
      },
      "name": "query - 8"
    }
  ],
  "fallbackResourceIds": [
     "Azure Monitor"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}